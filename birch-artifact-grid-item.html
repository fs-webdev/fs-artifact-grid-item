<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../cedar-card/cedar-card.html">
<link rel="import" href="../wc-i18n/wc-i18n.html">
<link rel="import" href="../oak-i18n-behavior/oak-i18n-behavior.html">
<link rel="import" href="audio-artifact/audio-artifact.html">
<link rel="import" href="image-artifact/image-artifact.html">
<link rel="import" href="story-artifact/story-artifact.html">
<link rel="import" href="../fs-styles/fs-styles.html">
<link rel="import" href="../oak-ajax-behavior/oak-ajax-behavior.html">
<link rel="import" href="../iron-ajax/iron-ajax.html">

<!-- @demo demo/index.html -->

<dom-module id='birch-artifact-grid-item'>
  <style include='fs-styles'></style>
  <link rel="import" type="css" href="birch-artifact-grid-item.css">
  <template>
    <iron-ajax id="postTitle"
      url="[[ajaxBase]]/artifactmanager/artifacts/[[data.id]]"
      headers='[[authHeaders]]'
      method="POST"
      on-response="_handlePostTitleResponse"
      on-error="_handlePostTitleError"></iron-ajax>
    <cedar-card>
      <div body>
        <div class="relative">
          <div id='artifact' class="artifact">

            <!-- IMAGE/DOCUMENT RENDERER -->
            <template is='dom-if' if="{{_isImage(data.category)}}">
              <image-artifact image-url='[[data.thumbSquareUrl]]'></image-artifact>
            </template>

            <!-- AUDIO RENDERER -->
            <template is='dom-if' if="{{_is(data.category, 'AUDIO')}}">
              <audio-artifact audio-url='[[data.url]]' title='[[data.title]]'></audio-artifact>
            </template>

            <!-- STORY RENDERER -->
            <template is='dom-if' if="{{_isStory(data.category)}}">
              <story-artifact image-url='[[data.thumbSquareUrl]]' description='[[data.description]]' title='[[data.title]]'></story-artifact>
            </template>

            <template is="dom-if" if="[[data.tombstoned]]">
              <div class="badge-wrapper">
                <small class='badge'>[[_getRemainingDaysCount(i18n, data)]]</small>
              </div>
            </template>

            <template is="dom-if" if="[[!data.tombstoned]]">
              <i class='not-tagged-icon' hidden='[[!_is(data.photoTagCount, 0)]]' title='[[i18n("not_tagged")]]'></i>
              <i class='comment-icon' hidden='[[!data.commentCount]]'>[[data.commentCount]]</i>
            </template>
          </div>

          <template is='dom-if' if='[[_hideContributorName(view, showContributed, _titleInputActive)]]'>
            <div class="title" title='[[data.title]]' on-tap="_stopProp">
              <i class="exclamation-icon" hidden="[[!_titleError]]"></i>
              <a class$="[[_calculateTitleClass(_titleError)]]" href$='[[_href]]' on-tap="_titleLinkOverride" hidden='[[_hideTitle(data.title, _titleInputActive)]]'>[[data.title]]</a>
              <a href$='[[_href]]?focus=title' class="add-title-link" on-tap="_toggleAddTitleInput" hidden='[[_hideAddTitle(readOnly, data.title, data.contributorCisUserId, owner, _titleInputActive)]]'>
                <i class='add-icon'></i>[[i18n('add_title')]]
              </a>
              <input class="title-input" type="text" maxlength='140' hidden="[[!_titleInputActive]]" on-keydown="_handleEnterExitBlur" on-blur="_handleEnterExitBlur" placeholder$="[[_addTitle]]" />
            </div>
          </template>
          <!-- Contributor Name -->
          <template is='dom-if' if='[[!_hideContributorName(view, showContributed, _titleInputActive)]]'>
            <div class="artifact-meta">
              <div class="title-2" title='[[data.title]]' on-tap="_stopProp">
                <i class="exclamation-icon" hidden="[[!_titleError]]"></i>
                <a class$="[[_calculateTitleClass(_titleError)]]" href$='[[_href]]' on-tap="_titleLinkOverride" hidden='[[_hideTitle(data.title, _titleInputActive)]]'>[[data.title]]</a>
                <a href$='[[_href]]?focus=title' class="add-title-link" on-tap="_toggleAddTitleInput" hidden='[[_hideAddTitle(readOnly, data.title, data.contributorCisUserId, owner, _titleInputActive)]]'>
                  <i class='add-icon'></i>[[i18n('add_title')]]
                </a>
              </div>
              <div class="contributor" title='[[_getContributorName(data.*)]]' hidden='[[!_getContributorName(data.*)]]'>
                <span id='contributor-link' on-click='_openContactCard'></span>
              </div>
            </div>
          </template>

          <!--Restricted-->
          <template is="dom-if" if="[[!data.tombstoned]]">
            <div class="restricted" hidden="[[!restricted]]" on-tap='_openInfoDialog'>
              <span class="restricted-message-wrapper">
                [[i18n('restricted')]]
              </span>
              <span class="info-icon" hidden='[[!_showRestrictedIcon]]'></span>
            </div>

            <template is='dom-if' if='[[showMessages]]'>
              <!-- Dim the thumbnail for error messages-->
              <div class='overlay' hidden="[[!_displayMessage]]" on-tap='_goToItem'></div>

              <!--Uploading-->
              <div class="overlay layout horizontal center center-justified" hidden="[[!uploading]]" on-tap='_goToItem'>
                <div class='processing'>
                  [[i18n('uploading')]]
                </div>
              </div>

              <!-- Upload Failed -->
              <div class="overlay layout horizontal center center-justified" hidden="[[!uploadFailed]]" on-tap='_goToItem'>
                <div class='error-text'>
                  [[i18n('upload_failed')]]
                </div>
              </div>

              <!--Processing-->
              <div class="overlay layout horizontal center center-justified" hidden="[[!processing]]" on-tap='_goToItem'>
                <div class='processing'>
                  [[i18n('processing')]]
                </div>
              </div>

              <!--Error Processing-->
              <div class="error-processing overlay layout horizontal center center-justified" hidden="[[!processingFailed]]" on-tap='_goToItem'>
                <div class="error-text">
                  [[i18n('processing_fail')]]
                </div>
              </div>

              <!--Screening-->
              <div class="overlay layout horizontal center center-justified" hidden="[[!screening]]" on-tap='_goToItem'>
                <div class='processing '>
                  [[i18n('screening')]]
                </div>
              </div>
            </template>
          </template>

        </div>
      </div>
    </cedar-card>
  </template>
</dom-module>
<script>
 (function() {
  Polymer({
    is: 'birch-artifact-grid-item',
    behaviors: [
      OakAJAXBehavior,
      WCI18n(),
      OakI18nBehavior,
    ],
    properties: {
      /**
       *
       * An artifactmanager artifact
       *
       * ```javascript
       * {
       *   "href": "./images/19687650",
       *   "category": "IMAGE",
       *   "url": "https://familysearch.org/patron/v2/TH-904-58554-804-13/dist.jpg?ctx=ArtCtxPublic",
       *   "thumbSquareUrl": "https://familysearch.org/patron/v2/TH-904-58554-804-13/thumb200.jpg?ctx=ArtCtxPublic",
       *   "title": "Demo Title",
       *   "description": "",
       *   "id": 19687650,
       *   "uploadDatetime": 1444242182000,
       *   "datesPlaces": null,
       *   "deepZoomLiteUrl": "https://familysearch.org/dzpatron/v1/TH-904-58554-804-13/scale?width=800&ctx=ArtCtxPublic",
       *   "screeningState": "APPROVED",
       *   "originalFilename": "Josh (BYU Football).jpg",
       *   "photoTagCount": 0,
       * }
       * ```
       *
       * @type {Object}
       */
      data: {
        type: Object,
        value: function() { return {}; }
      },
      /**
       * If set, enables the user to add a title inline.
      */
      inlineAddingEnabled: {
        type: Boolean,
        value: false
      },
      selectMode: {
        type: Boolean,
        value: false
      },
      /**
       * A flag to allow the contibutor
       * name to be shown
       */
      showContributed: {
        type: Boolean,
        value: false
      },
      /**
       * A flag to allow messages
       * to be shown
       */
      showMessages: {
        type: Boolean,
        value: false
      },
      /**
      * A flag for showing the restricted
      * info dialog
      */
      showRestrictedInfo: {
        type: Boolean,
        value: false
      },
      /**
      * Flag for showing the restricted icon
      */
      _showRestrictedIcon: {
        type: Boolean,
        computed: '_isOwner(showRestrictedInfo, owner, data.contributorCisUserId, restricted)'
      },
      /**
       * A state message is being displayed
       */
      _displayMessage: {
        type: Boolean,
        value: false
      },
      // State Messages
      screening: {
        type: Boolean,
        value: false
      },
      restricted: {
        type: Boolean,
        value: false
      },
      processing: {
        type: Boolean,
        value: false
      },
      processingFailed: {
        type: Boolean,
        value: false
      },
      uploading: {
        type: Boolean,
        value: false
      },
      uploadFailed: {
        type: Boolean,
        value: false
      },
      _href: {
        type: String,
        computed: '_computeHref(data.id)'
      },
      view: {
        type: String,
        value: null,
        observer: '_resetInputs'
      },
      owner: {
        type: String,
        value: ''
      },
      readOnly: {
        type: Boolean,
        value: false
      },
      /**
       * Notifier for if the add title input is active.
      */
      alertInputActive: {
        computed: '_computeIsActive(_titleInputActive)',
        notify: true
      },
      _titleInputActive: {
        type: Boolean,
        value: false
      },
      _titleError: {
        type: Boolean,
        value: false
      }
    },
    observers: [
      '_modifyState(data.*, showMessages)',
      '_translateContributor(i18n, data.*)'
    ],
    listeners: {
      'artifact.tap': '_goToItem'
    },
    _titleLinkOverride: function(e) {
      if (this.data.tombstoned) {
        e.preventDefault();
        return;
      }
      if (this._titleError) {
        e.preventDefault();
        this._titleError = false;
        this._toggleAddTitleInput();
      }
    },
    _getRemainingDaysCount: function(i18n, data) {
      if(!i18n || !i18n('remaining_days_count') || !data) return '';
      return i18n('remaining_days_count').replace('{0}', data.daysUntilDelete);
    },
    _calculateTitleClass: function(_titleError) {
      return (_titleError) ? 'title-text error-styling' : 'title-text';
    },
    _calcParams: function(view) {
      if (this.view === 'my-memories' || this.view === 'my-archive' || this.view === 'my-favorites') {
        return "?c="+this.view;
      } else if(parseInt(this.view)) {
        return "?a="+this.view;
      } else {
        return "?a=none";
      }
    },
    _modifyState: function(data, showMessages) {
      if(!showMessages) return;
      // Reset the states
      this.uploading = false;
      this.uploadFailed = false;
      this.processing = false;
      this.processingFailed = false;
      this.screening = false;
      this.restricted = false;
      this._displayMessage = false;
      // If just uploaded without refresh
      // don't check for the state
      if (this.data.recentlyUploaded) return;

      // Check upload state first and if it is not UPLOADED, display either UPLOADING or FAILED message as appropriate
      // Check processing state next.  If not PROCESSED, display appropriate state message
      // Check screening state. If not APPROVED, display RESTRICTED or SCREENING message as appropriate
      if (this.data.uploadState == 'UPLOADING') {
        this.uploading = true;
        this._displayMessage = true;
      } else if(this.data.uploadState == 'FAILED') {
        this.uploadFailed = true;
        this._displayMessage = true;
      } else if (this.data.category !== 'AUDIO' && this.data.imageProcessingState !== 'PROCESSED' && this.data.imageProcessingState !== 'FAILED') {
        this.processing = true;
        this._displayMessage = true;
      } else if (this.data.imageProcessingState === 'FAILED') {
        this.processingFailed = true;
        this._displayMessage = true;
      } else if (this.data.screeningState !== 'APPROVED' && this.data.screeningState !== 'ESCALATE' && this.data.screeningState !== 'RESTRICTED') {
        this.screening = true;
        this._displayMessage = true;
      } else if (this.data.screeningState === 'RESTRICTED') {
        this.restricted = true;
      }
    },
    _computeIsActive: function(titleInputActive) {
      if (titleInputActive) return true;
    },
    _computeHref: function(id) {
      var origin = window.location.origin;
      var path = (origin === 'http://localhost:5000') ? '' : '/photos';
      return origin + path + '/artifacts/' + id;
    },
    _deselectItem: function() {
      this.data.selected = false;
      this.fire('gallery-deselect-all');
    },
    _handleEnterExitBlur: function(e) {
      this._stopProp(e)
      if (e.keyCode == 13 || e.key == "Enter" || e.type == "blur") {
        e.preventDefault();
        if (e.currentTarget.value.length > 0) {
          this._saveTitle(e.currentTarget.value);
          e.currentTarget.value = '';
        } else {
          this._titleInputActive = false;
        }
        this._focusTitle();
      } else if (e.keyCode === 27) {
        // Handle exit key
        e.currentTarget.value = "";
        this.set('data.title', "");
        this._titleInputActive = false;
        this._focusTitle();
      }
    },
    _handlePostTitleError:function(e) {
      this._titleError = true;
      this.fire('artifact-item-title-update-failed', e.detail.error);
    },
    _handlePostTitleResponse:function(e) {
      if (e.detail.status < 400) this.fire('artifact-item-title-updated')
    },
    _hideAddTitle: function(readOnly, title, dataOwner, inputtedOwner, titleInputActive) {
      if (readOnly || title || titleInputActive || this.data.tombstoned) return true;
      if (inputtedOwner) {
        return dataOwner !== inputtedOwner;
      }
      return false;
    },
    _hideTitle: function (title, titleInputActive) {
      return (!title || titleInputActive);
    },
    _hideContributorName: function(view, showContributed, titleInputActive) {
      if (!showContributed || titleInputActive) return true;
      return (view != 'my-favorites' && !Number(view))
    },
    _isDefault: function(category) {
      return category === 'IMAGE' || category === 'DOCUMENT'
    },
    _is: function(a, b) {
      return a == b;
    },
    _isImage: function(category) {
      if (!category) return true;
      return category === 'IMAGE' || category === 'PORTRAIT' || category === 'UNKNOWN' || category === 'ANY' ||
             category === 'DOCUMENT' || category === 'PDF';
    },
    _isStory: function(category) {
      if (!category) return false;
      return category === 'STORY' || category === 'TEXT';
    },
    _isDocument: function(category) {
      if (!category) return false;
      return category === 'DOCUMENT' || category === 'PDF';
    },
    /*
      * Takes focus away from input, so keyboard closes on mobile devices.
    */
    _focusTitle: function() {
      if (document.activeElement.blur && typeof document.activeElement.blur === 'function') document.activeElement.blur();
      this.$$('.title-text').focus();
    },
    _goToItem: function(e) {
      if (this.selectMode || this.data.tombstoned) return;
      e.preventDefault();
      e.stopPropagation();
      var url = this._href;

      var newTab = false;
      if (e && e.detail && e.detail.sourceEvent) {
        newTab = e.detail.sourceEvent.ctrlKey || e.detail.sourceEvent.metaKey
      }
      if (this.view === 'my-memories' || this.view === 'my-archive' || this.view === 'my-favorites') {
        url = url + "?c="+this.view;
      } else if(parseInt(this.view)) {
        url = url + "?a="+this.view;
      }
      if (newTab){
        window.open(url, '_blank').focus();
      } else {
        location = url;
      }
    },
    _resetInputs: function() {
      if (this._titleError) this._titleError = false;
      if (this.$$('.title-input')) this.$$('.title-input').value = "";
    },
    _saveTitle: function(titleText) {
      this.$.postTitle.body = {
        title: titleText
      };
      this.$.postTitle.generateRequest();
      this._titleInputActive = false;
      this.set('data.title', titleText);
    },
    _stopProp: function(e) {
      if (!this.selectMode) e.stopPropagation();
    },
    _toggleAddTitleInput: function(e) {
      if (this.inlineAddingEnabled) {
        if (e) e.preventDefault();
        this._titleInputActive = true;
        // Flush dom so nothing takes the focus after the title input is focus.
        Polymer.dom.flush();
        this.$$('.title .title-input').focus();
      }
    },
    _openContactCard: function(e) {
      e.stopPropagation();
      this.fire('gallery-close-contact-card',{});
      var contactData = {'event': e, 'cisId': this.data.contributorCisUserId }
      this.fire('gallery-open-contact-card', contactData);
    },
    _translateContributor: function(i18n, data) {
      if (!this.showContributed || !data || !data.value || !i18n || !i18n('contributed_by_link')) return;
      var name = (data.value.ftUserInfo) ? data.value.ftUserInfo.contactName : data.value.contributorContactName;
      var contributor = this.$$('#contributor-link');
      if (contributor) contributor.innerHTML = i18n('contributed_by_link').replace('{0}', name);
    },
    _openInfoDialog: function(e) {
      e.stopPropagation();
      e.preventDefault();
      if (!this.showRestrictedInfo || this.owner !== this.data.contributorCisUserId) return;
      var data = {};
      data.translations = {};
      data.translations.restrictedInfo = this.i18n('restricted_info');
      data.translations.checkEmail = this.i18n('check_email');
      data.target = this.$$('.info-icon');
      this.fire('open-restricted-info', data);
    },
    _isOwner: function(ex, user, owner, restricted) {
      if (!restricted || !ex) return false;
      return (user === owner);
    },
    _getContributorName: function(data) {
      if (data && data.value) {
        return (data.value.ftUserInfo) ? data.value.ftUserInfo.contactName : data.value.contributorContactName;
      }
    }
  });
})();
</script>
