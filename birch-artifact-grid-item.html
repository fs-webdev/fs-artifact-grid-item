<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../cedar-card/cedar-card.html">
<link rel="import" href="../wc-i18n/wc-i18n.html">
<link rel="import" href="../oak-i18n-behavior/oak-i18n-behavior.html">
<link rel="import" href="audio-artifact/audio-artifact.html">
<link rel="import" href="image-artifact/image-artifact.html">
<link rel="import" href="story-artifact/story-artifact.html">
<link rel="import" href="../fs-styles/fs-styles.html">
<link rel="import" href="../oak-ajax-behavior/oak-ajax-behavior.html">
<link rel="import" href="../iron-ajax/iron-ajax.html">

<!-- @demo demo/index.html -->

<dom-module id='birch-artifact-grid-item'>
  <style include='fs-styles'></style>
  <link rel="import" type="css" href="birch-artifact-grid-item.css">
  <template>
    <wc-i18n-src locale='[[lang]]' locale-dir='[[localeDir()]]' domain='birch-artifact-grid-item'></wc-i18n-src>
    <iron-ajax id="postTitle"
      url="[[ajaxBase]]/artifactmanager/artifacts/[[data.id]]"
      headers='[[authHeaders]]'
      method="POST"
      on-response="_handlePostTitleResponse"
      on-error="_handlePost_TitleError"></iron-ajax>
    <cedar-card>
      <div class="relative">
        <div id='artifact' class="artifact">

          <!-- IMAGE/DOCUMENT RENDERER -->
          <template is='dom-if' if="{{_isImage(data.category)}}">
            <image-artifact image-url='[[data.thumbUrl]]'></image-artifact>
          </template>

          <!-- AUDIO RENDERER -->
          <template is='dom-if' if="{{_is(data.category, 'AUDIO')}}">
            <audio-artifact audio-url='[[data.url]]' title='[[data.title]]'></audio-artifact>
          </template>

          <!-- STORY RENDERER -->
          <template is='dom-if' if="{{_isStory(data.category)}}">
            <story-artifact image-url='[[data.thumbUrl]]' description='[[data.description]]' title='[[data.title]]'></story-artifact>
          </template>

          <wc-i18n key='birch-artifact-grid-item.not_tagged' provider value='{{_notTaggedText}}'></wc-i18n>
          <i class='not-tagged-icon' hidden='[[!_is(data.photoTagCount, 0)]]' title='[[_notTaggedText]]'></i>
          <i class='comment-icon' hidden='[[!data.commentCount]]'>[[data.commentCount]]</i>
        </div>

        <template is='dom-if' if='[[_hideContributorName(view, showContributed, _titleInputActive)]]'>
          <div class="title" title='[[data.title]]' on-tap="_stopProp">
            <i class="exclamation-icon" hidden="[[!_titleError]]"></i>
            <a class$="[[_calculateTitleClass(_titleError)]]" href$='[[_href]]' on-tap="_titleLinkOverride" hidden='[[_hideTitle(data.title, _titleInputActive)]]'>[[data.title]]</a>
            <a href$='[[_href]]?focus=title' class="add-title-link" on-tap="_toggleAddTitleInput" hidden='[[_hideAddTitle(readOnly, data.title, data.contributorCisUserId, owner, _titleInputActive)]]'>
              <i class='add-icon'></i><wc-i18n key='birch-artifact-grid-item.add_title'></wc-i18n>
            </a>
            <input class="title-input" type="text" maxlength='140' hidden="[[!_titleInputActive]]" on-keypress="_handleEnterAndBlur" on-keydown="_stopPropHandleExit" on-blur="_handleEnterAndBlur" placeholder="Add a title" />
          </div>
        </template>
        <!-- Contributor Name -->
        <wc-i18n key='birch-artifact-grid-item.contributed_by' provider value='{{_contributedBy}}'></wc-i18n>
        <template is='dom-if' if='[[!_hideContributorName(view, showContributed, _titleInputActive)]]'>
          <div class="artifact-meta">
            <div class="title-2" title='[[data.title]]' on-tap="_stopProp">
              <i class="exclamation-icon" hidden="[[!_titleError]]"></i>
              <a class$="[[_calculateTitleClass(_titleError)]]" href$='[[_href]]' on-tap="_titleLinkOverride" hidden='[[_hideTitle(data.title, _titleInputActive)]]'>[[data.title]]</a>
              <a href$='[[_href]]?focus=title' class="add-title-link" on-tap="_toggleAddTitleInput" hidden='[[_hideAddTitle(readOnly, data.title, data.contributorCisUserId, owner, _titleInputActive)]]'>
                <i class='add-icon'></i><wc-i18n key='birch-artifact-grid-item.add_title'></wc-i18n>
              </a>
            </div>
            <div class="contributor" title='[[data.ftUserInfo.contactName]]'>
               <span>[[_translateContributor(_contributedBy)]]</span><span class='contributor-name' on-tap='_openContactCard'>[[data.ftUserInfo.contactName]]</span>
            </div>
          </div>
        </template> 

        <!--Restricted-->
        <div class="restricted" hidden="[[!restricted]]">
            <wc-i18n class='fs-h5' key='birch-artifact-grid-item.restricted'></wc-i18n>
        </div>

        <template is='dom-if' if='[[showMessages]]'>
          <!-- Dim the thumbnail for error messages-->
          <div class='overlay' hidden="[[!_displayMessage]]" on-tap='_goToItem'></div>

          <!--Uploading-->
          <div class="overlay layout horizontal center center-justified" hidden="[[!uploading]]" on-tap='_goToItem'>
            <div class='processing'>
                <wc-i18n key='birch-artifact-grid-item.uploading'></wc-i18n>
            </div>
          </div>

          <!--Processing-->
          <div class="overlay layout horizontal center center-justified" hidden="[[!processing]]" on-tap='_goToItem'>
            <div class='processing'>
                <wc-i18n key='birch-artifact-grid-item.processing'></wc-i18n>
            </div>
          </div>

          <!--Error Processing-->
          <div class="error-processing overlay layout horizontal center center-justified" hidden="[[!processingFailed]]" on-tap='_goToItem'>
            <div class="error-text">
              <wc-i18n key='birch-artifact-grid-item.processing_fail'></wc-i18n>
            </div>
          </div>

          <!--Screening-->
          <div class="overlay layout horizontal center center-justified" hidden="[[!screening]]" on-tap='_goToItem'>
            <div class='processing '>
                <wc-i18n class='fs-h5' key='birch-artifact-grid-item.screening'></wc-i18n>
            </div>
          </div>
        </template>

      </div>
    </cedar-card>
  </template>
</dom-module>
<script>
 (function() {
  Polymer({
    is: 'birch-artifact-grid-item',
    behaviors: [
      OakAJAXBehavior,
      WCI18nBehavior,
      OakI18nBehavior,
    ],
    properties: {
      /**
       *
       * An artifactmanager artifact
       *
       * ```javascript
       * {
       *   "href": "./images/19687650",
       *   "category": "IMAGE",
       *   "url": "https://familysearch.org/patron/v2/TH-904-58554-804-13/dist.jpg?ctx=ArtCtxPublic",
       *   "thumbUrl": "https://familysearch.org/patron/v2/TH-904-58554-804-13/thumb200.jpg?ctx=ArtCtxPublic",
       *   "title": "Demo Title",
       *   "description": "",
       *   "id": 19687650,
       *   "uploadDatetime": 1444242182000,
       *   "datesPlaces": null,
       *   "deepZoomLiteUrl": "https://familysearch.org/dzpatron/v1/TH-904-58554-804-13/scale?width=800&ctx=ArtCtxPublic",
       *   "screeningState": "APPROVED",
       *   "originalFilename": "Josh (BYU Football).jpg",
       *   "photoTagCount": 0,
       * }
       * ```
       *
       * @type {Object}
       */
      data: {
        type: Object,
        value: function() { return {}; }
      },
      inlineAddingEnabled: {
        type: Boolean,
        value: false
      },
      selectMode: {
        type: Boolean,
        value: false
      },
      /**
       * A flag to allow the contibutor
       * name to be shown
       */
      showContributed: {
        type: Boolean,
        value: false
      },
      /**
       * A flag to allow messages
       * to be shown
       */
      showMessages: {
        type: Boolean,
        value: false
      },
      /**
       * A state message is being displayed
       */
      _displayMessage: {
        type: Boolean,
        value: false
      },
      // State Messages
      screening: {
        type: Boolean,
        value: false
      },
      restricted: {
        type: Boolean,
        value: false
      },
      processing: {
        type: Boolean,
        value: false
      },
      processingFailed: {
        type: Boolean,
        value: false
      },
      uploading: {
        type: Boolean,
        value: false
      },
      _href: {
        type: String,
        computed: '_computeHref(data.id)'
      },
      view: {
        type: String,
        value: null,
        observer: '_resetInputs'
      },
      owner: {
        type: String,
        value: ''
      },
      readOnly: {
        type: Boolean,
        value: false
      },
      _titleInputActive: {
        type: Boolean,
        value: false
      },
      _titleError: {
        type: Boolean,
        value: false
      }
    },
    observers: [
      '_modifyState(data.*, showMessages)'
    ],
    listeners: {
      'artifact.tap': '_goToItem'
    },
    _titleLinkOverride: function(e) {
      if (this._titleError) {
        e.preventDefault();
        this._titleError = false;
        // The title class variable helps determine whether the contributor or normal title should be used
        var titleClass = (this.view == 'my-favorites' || Number(this.view)) ? '.title-2' : '.title';
        this._toggleAddTitleInput();
      }
    },
    _calculateTitleClass: function(_titleError) {
      return (_titleError) ? 'title-text error-styling' : 'title-text';
    },
    _calcParams: function(view) {
      if (this.view === 'my-memories' || this.view === 'my-archive' || this.view === 'my-favorites') {
        return "?c="+this.view;
      } else if(parseInt(this.view)) {
        return "?a="+this.view;
      } else {
        return "?a=none";
      }
    },
    _modifyState: function(data, showMessages) {
      if(!showMessages) return;
      // Reset the states
      this.uploading = false;
      this.processing = false;
      this.processingFailed = false;
      this.screening = false;
      this.restricted = false;
      this._displayMessage = false;
      // If just uploaded without refresh
      // don't check for the state
      if (this.data.recentlyUploaded) return;

      // Check upload state first and if it is not UPLOADED, display either UPLOADING or FAILED message as appropriate
      // Check processing state next.  If not PROCESSED, display appropriate state message
      // Check screening state. If not APPROVED, display RESTRICTED or SCREENING message as appropriate
      if (this.data.uploadState == 'UPLOADING') {
        this.uploading = true;
      } else if (this.data.category !== 'AUDIO' && this.data.imageProcessingState !== 'PROCESSED' && this.data.imageProcessingState !== 'FAILED') {
        this.processing = true;
      } else if (this.data.imageProcessingState === 'FAILED') {
        this.processingFailed = true;
      } else if (this.data.screeningState !== 'APPROVED' && this.data.screeningState !== 'ESCALATE' && this.data.screeningState !== 'RESTRICTED') {
        this.screening = true;
      } else if (this.data.screeningState === 'RESTRICTED') {
        this.restricted = true;
      }

      if (this.uploading || this.processing || this.screening || this.processingFailed) this._displayMessage = true;
    },
    _computeHref: function(id) {
      var origin = window.location.origin;
      var path = (origin === 'http://localhost:5000') ? '' : '/photos';
      return origin + path + '/artifacts/' + id;
    },
    _deselectItem: function() {
      this.data.selected = false;
      this.fire('gallery-deselect-all');
    },
    _handleEnterAndBlur: function(e) {
      if ((e.keyCode == 13 || e.key == "Enter" || e.type == "blur") && e.currentTarget.value.length > 0) {
        this._saveTitle(e.currentTarget.value);
      } else if ((e.keyCode == 13 || e.key == "Enter" || e.type == "blur") && e.currentTarget.value.length == 0) { 
        this._titleInputActive = false;
      }
    },
    _handlePost_TitleError:function(e) {
      this._titleError = true;
      this.fire('artifact-item-title-update-failed', e.detail.error);
    },
    _handlePostTitleResponse:function(e) {
      if (e.detail.status < 400) this.fire('artifact-item-title-updated')
    },
    _hideAddTitle: function(readOnly, title, dataOwner, inputtedOwner, titleInputActive) {
      if (readOnly || title || titleInputActive) return true;
      if (inputtedOwner) {
        return dataOwner !== inputtedOwner;
      }
      return false;
    },
    _hideTitle: function (title, titleInputActive) {
      return (!title || titleInputActive);
    },
    _hideContributorName: function(view, showContributed, titleInputActive) {
      if (!showContributed || titleInputActive) return true;
      return (view != 'my-favorites' && !Number(view))
    },
    _isDefault: function(category) {
      return category === 'IMAGE' || category === 'DOCUMENT'
    },
    _is: function(a, b) {
      return a == b;
    },
    _isImage: function(category) {
      if (!category) return true;
      return category === 'IMAGE' || category === 'PORTRAIT' || category === 'UNKNOWN' || category === 'ANY' ||
             category === 'DOCUMENT' || category === 'PDF';
    },
    _isStory: function(category) {
      if (!category) return false;
      return category === 'STORY' || category === 'TEXT';
    },
    _isDocument: function(category) {
      if (!category) return false;
      return category === 'DOCUMENT' || category === 'PDF';
    },
    _goToItem: function(e) {
      if (this.selectMode) return;
      e.preventDefault();
      e.stopPropagation();
      var url = this._href;

      var newTab = false;
      if (e && e.detail && e.detail.sourceEvent) {
        newTab = e.detail.sourceEvent.ctrlKey || e.detail.sourceEvent.metaKey
      } 
      if (this.view === 'my-memories' || this.view === 'my-archive' || this.view === 'my-favorites') {
        url = url + "?c="+this.view;
      } else if(parseInt(this.view)) {
        url = url + "?a="+this.view;
      }
      if (newTab){
        window.open(url, '_blank').focus();
      } else {
        location = url;
      }
    },
    _resetInputs: function() {
      if (this._titleError) this._titleError = false;
      if (this.$$('.title-input')) this.$$('.title-input').value = "";
    },
    _saveTitle: function(titleText) {
      this.$.postTitle.body = {
        title: titleText
      };
      this.$.postTitle.generateRequest();
      this._titleInputActive = false;
      this.set('data.title', titleText);
    },
    _stopPropHandleExit: function(e) {
      this._stopProp(e);
      if (e.keyCode === 27) {
        e.currentTarget.value = "";
        this.set('data.title', "");
        this._titleInputActive = false;
        this.blur();
      }
    },
    _stopProp: function(e) {
      if (!this.selectMode) e.stopPropagation();
    },
    _toggleAddTitleInput: function(e) {
      if (this.inlineAddingEnabled) {
        if (e) e.preventDefault();
        this._titleInputActive = true;
        Polymer.dom.flush();
        this.$$('.title .title-input').focus();
      }
    },
    _openContactCard: function(e) {
      e.stopPropagation();
      this.fire('gallery-close-contact-card',{});
      var contactData = {'event': e, 'data': this.data.ftUserInfo }
      this.fire('gallery-open-contact-card', contactData);
    },
    _translateContributor: function(val) {
      return (val) ? val.replace('{0}', '') : '';
    }
  });
})();
</script>
