<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../wc-i18n/wc-i18n.html">
<link rel="import" href="../oak-i18n-behavior/oak-i18n-behavior.html">
<link rel="import" href="./birch-artifact-grid-item.html">
<link rel="import" href="../fs-styles/fs-styles.html">

<dom-module id='birch-artifact-grid-item-preview'>
  <style include='fs-styles'></style>
  <link rel="import" type="css" href="birch-artifact-grid-item-preview.css">
  <template>
    <div class="relative">
    <birch-artifact-grid-item data="[[data]]"></birch-artifact-grid-item>
    <div class="grid-item-preview-overlay">
      <div class="spinner" hidden="[[!loading]]"></div>
      <div class="error-uploading full layout horizontal end" hidden="[[!data.uploadError]]">
        <div class="error-text" hidden="[[!data.failure]]">
          <span>
            [[i18n('try_again')]]
          </span>
          <!-- <a href="javascript:;" on-tap="_retryUpload">
            [[i18n('retry')]]
          </a> -->
        </div>
        <div class="error-text" hidden="[[!data.duplicate]]">
          <span>
            [[i18n('duplicate')]]
          </span>
        </div>
        <div class="error-text" hidden="[[!data.tooBig]]">
          <span>
            [[i18n('size')]]
          </span>
        </div>
        <div class="error-text" hidden="[[!data.unsupported]]">
          <span>
            [[i18n('unsupported')]]
          </span>
        </div>
        <div class="error-text" hidden="[[!data.tryAgain]]">
          <span>
            [[i18n('fail_continues')]]
          </span>
        </div>
      </div>

      <div id="memory-title" hidden="[[!data.uploadError]]"></div>
    </div>
    </div>
  </template>
</dom-module>
<script>
(function() {

  var getScaledImage = function(dataUrl) {
    return new Promise(function(resolve, reject) {
      var size = 170;
      var canvas = document.createElement("canvas");
      var c = canvas.getContext("2d");
      var img = new Image();
      img.onload = function(e) {
        var scale = size / (this.width > this.height ? this.width : this.height);
        canvas.width = this.width * scale;
        canvas.height = this.height * scale;
        c.drawImage(this, 0, 0, canvas.width, canvas.height);
        resolve(canvas.toDataURL("image/jpeg", 1));
      }
      img.src = dataUrl;
    });
  }

  Polymer({
    is: 'birch-artifact-grid-item-preview',
    behaviors: [
      WCI18n(),
      OakI18nBehavior
    ],
    properties: {
      /**
       * A file upload object containing two properties
       * ```
       * {
       *   file: FileObject,
       *   promise: PromiseObject
       * }
       * ```
       *
       * If the promise resolves with an object with an `err`
       * property **or** rejects then error handling will occur
       * based on the err type
       *
       * Otherwise the promise should resolve with an object
       * containing an `artifact` property. This property will be
       * used to bootstrap the underlying `birch-artifact-grid-item`
       * @type {Object}
       */
      data: {
        type: Object,
        value: function(){ return {}; },
        observer: '_attachPromiseHandler',
        notify: true
      },
      loading: {
        type: Boolean,
        value: true
      },
    },
    listeners: {
      tap: '_stopPropagation',
      contextmenu: '_stopPropagation'
    },
    observers: [
      '_handleImportError(data.importError)'
    ],
    /**
     * Handles the updating of data we need this
     * because iron-list listens for changes to items.*
     * and an actual item changing breaks it. Therefore
     * we set all of the properties individually and it fixes
     * the issue
     */
    _stopPropagation: function(e) {
      e.stopPropagation();
    },
    _updateData: function(artifact) {
      var keys = Object.keys(artifact);
      keys.forEach(function(key) {
        var path = 'data.' + key;
        this.set(path, artifact[key]);
      }.bind(this));
    },
    _attachPromiseHandler: function() {
      if (!this.data || !this.data.promise || typeof this.data.promise.then !== 'function') return;
      this.data.promise.then(function (result){
        if(result.err){
          this._handleUploadError(result.err);
          return;
        }
        var artifact = (Array.isArray(result.items)) ? result.items[0] : result.artifact;
        var thumbSquareUrl = result.artifact ? result.artifact.thumbSquareUrl : null;
        artifact.thumbSquareUrl = this.data.thumbSquareUrl || thumbSquareUrl;
        if(!this.data.thumbSquareUrl){
          setTimeout(function(){
            this._updateData(artifact);
          }.bind(this), 5000);
        } else {
          this._updateData(artifact);
        }
        return result;
      }.bind(this), this._handleUploadError.bind(this));
      // Sanity check that it's not an import file
      if (this.data.file && !this.data.file.url) this._getDataUrl(this.data.file);
    },
    _handleUploadError: function(status){
      if (status == 409) {
        this.set('data.duplicate', true);
      } else if (status == 413) {
        this.set('data.tooBig', true);
      } else if (status == 415) {
        this.set('data.unsupported', true);
      } else if (status > 399 && status < 500) {
        this.set('data.tryAgain', true);
      } else {
        this.set('data.failure', true);
      }

      this.loading = false;
      this.set('data.uploadError', true);
      // Sanity check that it's not an import which wouldn't have a file name
      if (this.data.file && this.data.file.name) this.$['memory-title'].innerText = this.data.file.name;
    },
    _handleImportError: function(status) {
      if (status) {
        this._handleUploadError(status);
      }
    },
    _getDataUrl: function(file){
      var _this = this;
      var reader = new FileReader();
      reader.onload = (function() {
        return function(e) {
          getScaledImage(e.target.result).then(function(image) {
            _this.set('data.thumbSquareUrl', image);
          });
        };
      })();
      reader.readAsDataURL(file);
    }
  });
})();
</script>
